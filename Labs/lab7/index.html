<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  <link color="#5bbad5" href='&#x2F;icons&#x2F;safari-pinned-tab.svg' rel="mask-icon" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css" integrity="sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH" crossorigin="anonymous">
  

  
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" integrity="sha384-oGm59HWAkwO32h2w8u0B98wKBZJwd6MbWtAJwQKCTffZjOXHXrnyv9Syjovgc+UV" crossorigin="anonymous">
  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link href="https://henrycc24.github.io/deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
 | Lab 7

  </title>

  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=&lt;your_gtag&gt;"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "&lt;your_gtag&gt;");
  </script>
  
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx" crossorigin="anonymous"></script>

  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js" integrity="sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT" crossorigin="anonymous"></script>
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
  
  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href="https:&#x2F;&#x2F;henrycc24.github.io"></a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;henrycc24.github.io&#x2F;">
            Home
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;henrycc24.github.io&#x2F;Labs">
            Labs
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;henrycc24.github.io&#x2F;about">
            about
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;henrycc24.github.io&#x2F;reference">
            references
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            Lab 7
          </h1>
          <p class="subtitle">Kalman Filter</p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>DeepThought published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2025-03-24">March 24, 2025</time></span>
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>5 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>844 words</span>
</span>

            </div>
            <div class="column">
              
            </div>
            <div class="column has-text-right-desktop">
              
            </div>
          </div>
          <div class="content mt-2">
            <blockquote>
<p>Lab7 : Kalman Filter Implementation</p>
</blockquote>
<h1 id="tasks">Tasks</h1>
<h1 id="lab-7">Lab 7</h1>
<h2 id="1-estimating-drag-and-momentum">**1. Estimating Drag and Momentum **</h2>
<p>To build the state space model we need to calculate drag and momentum terms for the A and B matrices. First we must choose a step resone (PWM Value) to run the car at.  I chose a PWM of 124</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/position.png" alt="alt text" /> <img src="https://henrycc24.github.io/Labs/lab7/pwm.png" alt="alt text" />
<img src="https://henrycc24.github.io/Labs/lab7/speed.png" alt="alt text" /></p>
<p>These are the associated speed, position, and PWM graphs I got from my car.</p>
<p>With these values collected I calculated the drag and momentum using these formulas from lecture.</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/formulas.png" alt="alt text" /> <img src="https://henrycc24.github.io/Labs/lab7/more_form.png" alt="alt text" /></p>
<p>Implementing it in Python:</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/drag_code.png" alt="alt text" /> <img src="https://henrycc24.github.io/Labs/lab7/Drag_mom.png" alt="alt text" /></p>
<p>To calculate these values I needed to get a steady state value for my speed. I used 1st order system formula from lecture 14 slides:</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/steady.png" alt="alt text" /></p>
<p>To get a value of 2133 mm/s. which for 90% will get you 1919.7 mm/s. For the dt I calculated by finding the avgerage sampling rate of all the collected values which turned out to be .009 seconds.</p>
<h2 id="2-initializing-kf">**2. Initializing KF **</h2>
<p><img src="https://henrycc24.github.io/Labs/lab7/AnB.png" alt="alt text" /> <img src="https://henrycc24.github.io/Labs/lab7/AdnBd.png" alt="alt text" /></p>
<p><img src="https://henrycc24.github.io/Labs/lab7/Acode.png" alt="alt text" /> <img src="https://henrycc24.github.io/Labs/lab7/Avalues.png" alt="alt text" /></p>
<p>Following the formulas from the same lecture we use the momentum and drag values we calculated to get arrays A and B. Keeping in mind that dt is our sampling rate from earlier.</p>
<p>C is an m x n matrix where n are the dimenstion in the state space and m are the # of states. For this we set it as [1,0] since we are measuring positive distance from the wall (state 0)</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/steady_state_code.png" alt="alt text" /></p>
<p>Next we have to intialize the state vector. The first position is the first reading from the TOF at rest. The velocity is set to 0 since the car isn't moving.</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/sigma_matrix.png" alt="alt text" /> <img src="https://henrycc24.github.io/Labs/lab7/sigma_code.png" alt="alt text" /></p>
<p>Following that we now need to calculate our sigma z and u matrixes. To do this we need to find the standard deviation of our measurment and process noise. Sigma 3 is set at 20 mm to match the ranging error of long distance mode which was used to collect data for the ToF.</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/long_distance.png" alt="alt text" /></p>
<p>For sigma 1 and sigma 2 used the formula $\sqrt{u * (1/dt) }$ where u in our case will be the mean value of 10. This gave us a sigma of ~33 mm/s where sigma 1 correlates with the trusted model position and sigma 2 is speed.</p>
<h2 id="3-kalman-filter-in-jupyter"><strong>3. Kalman Filter in Jupyter</strong></h2>
<p><img src="https://henrycc24.github.io/Labs/lab7/kf_code.png" alt="alt text" /></p>
<p>Next was implementing the filter in jupyter notebook. To do this I based my code from the provided code in lecture, and set an intial sigma with similar paramters to before. However, this time I set the sigma1 to a value of 143mm/s since this was the value i calculated when I took the std of my velocity. I wanted to get a more precise value for this case to see if it'll line up more. This is the resulting graph of it. The other graph where the end values don't match up as nice is the result of me using a insital sigma of 20. This change in value led to a significant change in graph especially since when squared 400 &lt;&lt; 20,000.</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/kalman_filter.png" alt="alt text" />
<img src="https://henrycc24.github.io/Labs/lab7/kalman_better.png" alt="alt text" /></p>
<p>I wanted to experiment with different dt values, and to do so I simply tested it by adding serial print statments to slow down the ToF.</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/kalman_lower.png" alt="alt text" /></p>
<p>Running the KF filter with base paramters as before actually gave pretty code results even with a lower dt. Dt directly changes the Ad array, the momentum calcualtion, and sigma values used for these matrixes, hwoever, as long as you configure it right it can accurately display the steady state in the system. The above image is showcasing a dt of .223 which is ~2.4 times slower then the original of .09.</p>
<h2 id="4-running-it-on-the-lil-homie"><strong>4. Running it on the lil Homie</strong></h2>
<p>Alright now for the true test running it on my robot lil Homie. First of we have to include the linear algebra library and download it doing
#include &lt;BasicLinearAlgebra.h&gt;</p>
<p>Alright to implement in C took a while however, since it was first coded in python it was just like translating a different language and such we got these following functions/code:</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/updated_KF.png" alt="alt text" /> <img src="https://henrycc24.github.io/Labs/lab7/Kalman_c.png" alt="alt text" />
<img src="https://henrycc24.github.io/Labs/lab7/kalman_function.png" alt="alt text" /></p>
<p>Unlke lab5 there is no extroplation being taken place here. Instead how it works is that if the sensor is ready it will provide its current position and feed it into the kalman filter, and then the kalman filter will output its state vector which then again will call our PID function that we implemented last time. In which we have a designeted distance (1ft ~ 300 mm) that we want our robot to be away from.</p>
<p><img src="https://henrycc24.github.io/Labs/lab7/Robot_kf.png" alt="alt text" /></p>
<p>Here a graph of it which accurately displays how it ran where it was to close then backed up and once it hits it distance it shut off the PWM. As shown below:</p>
<p><a href="https://youtu.be/sLueyu8xcOM"><img src="https://markdown-videos-api.jorgenkh.no/youtube/sLueyu8xcOM" alt="" /></a></p>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
              
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;henrycc24.github.io&#x2F;Labs&#x2F;lab1&#x2F;">
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              Lab 1
            </a>
          </div>
           
        </nav>
      </div>
    </div>
  </div>
</section>



  



  
  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>
  

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js" integrity="sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js" integrity="sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.5/dist/mermaid.min.js" integrity="sha384-0yWn54pSGtfKCU+skfA69l25VsCw+MZt4LQov3xNRoS7YkAMrFokGgSBnAWSK4pv" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1.1.13/dist/chart.xkcd.min.js" integrity="sha384-xC3h1+IHXK8seA+8KfT79Z4e0GPsznjXBoMa5nd8ooWKplPyXx92NOmljWxLC/cs" crossorigin="anonymous"></script>
  
  
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js" integrity="sha384-Pulw7+h73841BQIK0LzJCydKRPChJUF9w8h8W0o3h+cLtoyNPJS847bQauLWOTwg" crossorigin="anonymous"></script>
  
  <script src="https://henrycc24.github.io/elasticlunr.min.js"></script>
  <script src="https://henrycc24.github.io/search_index.en.js"></script><script src="https://henrycc24.github.io/js/site.js"></script>

  





  
  
</body>

</html>
